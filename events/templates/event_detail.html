{% extends 'base.html' %}
{% block content %}
<div id="event" class="card">Chargement...</div>

<!-- Modal de paiement -->
<div id="paymentModal" class="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:60">
  <div style="background:#fff;padding:20px;border-radius:8px;max-width:520px;width:94%">
    <h3 id="pm-title">Paiement sécurisé</h3>

    <div style="margin-top:8px">
      <label>Quantité (1–5)</label>
      <input id="pm-quantity" type="number" min="1" max="5" value="1" style="width:80px;padding:8px;border-radius:6px;border:1px solid #ddd" />
    </div>

    <div style="margin-top:8px">
      <label>Paiement par carte (26 chiffres)</label>
      <input id="pm-no-card" type="text" inputmode="numeric" maxlength="26" placeholder="Entrez 26 chiffres" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd" />
      <small style="color:#6b7280">Si vous payez par carte, entrez les 26 chiffres qui vous ont été fournis.</small>
    </div>

    <div style="margin-top:8px">
      <label>Nom & Prénom</label>
      <input id="pm-name" type="text" placeholder="Prénom Nom" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd" />
    </div>

    <div style="margin-top:8px">
      <label>Email</label>
      <input id="pm-email" type="email" placeholder="email@exemple.com" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd" />
    </div>

    <p id="pm-body" style="margin-top:12px;color:#555">Montant total: 0 TND</p>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="pm-cancel" class="btn">Annuler</button>
      <button id="pm-pay" class="btn btn-primary">Payer maintenant</button>
    </div>
  </div>
</div>

<script>
const eventId = {{ event_id }};

async function load() {
  const res = await fetch(`/api/events/${eventId}/`);
  const container = document.getElementById('event');
  if(!res.ok){ container.innerText='Événement introuvable'; return; }

  const ev = await res.json();
  container.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 320px;gap:20px;align-items:start">
      <div>
        <h2>${ev.title}</h2>
        <p class="muted">${new Date(ev.date).toLocaleString()} • ${ev.location ? ev.location.name : 'En ligne'}</p>
        <p>${ev.description || ''}</p>
      </div>
      <aside class="card" style="background:linear-gradient(180deg,#fff,#f8fbff)">
        <div class="muted">Prix</div>
        <h3 style="margin-top:6px">${ev.price ?? 'Gratuit'}</h3>
        <div style="margin-top:12px">
          <button id="bookBtn">Réserver</button>
        </div>
        <div id="result" style="margin-top:12px"></div>
      </aside>
    </div>
  `;

  document.getElementById('bookBtn').onclick = async () => {
    if(!window.CURRENT_USER || !window.CURRENT_USER.is_authenticated){
      const next = encodeURIComponent(window.location.pathname + window.location.search);
      window.location.href = `/accounts/login/?next=${next}`;
      return;
    }

    // Step 1: créer le paiement
    const createResp = await fetch('/api/payments/create/', {
      method:'POST',
      credentials:'same-origin',
      headers:{'Content-Type':'application/json','X-CSRFToken':window.CSRF_TOKEN},
      body: JSON.stringify({event_id: ev.id, quantity: 1})
    });
    if(!createResp.ok){ alert('Erreur création paiement'); return; }
    const createData = await createResp.json();

    // Step 2: afficher le modal
    showModal(ev.price || 0, async (qty) => {
      const buyerName = document.getElementById('pm-name').value || window.CURRENT_USER.username || '';
      const buyerEmail = document.getElementById('pm-email').value || window.CURRENT_USER.email || '';
      const noCardRef = document.getElementById('pm-no-card').value.trim();

      const payload = { payment_id: createData.payment_id, event_id: ev.id, quantity: qty, buyer_name: buyerName, buyer_email: buyerEmail };
      if(noCardRef) payload.no_card_ref = noCardRef;

      const confirmResp = await fetch('/api/payments/confirm/', {
        method:'POST',
        credentials:'same-origin',
        headers:{'Content-Type':'application/json','X-CSRFToken':window.CSRF_TOKEN},
        body: JSON.stringify(payload)
      });

      if(!confirmResp.ok){ const d=await confirmResp.json(); alert('Erreur paiement: '+(d.detail||JSON.stringify(d))); return; }
      const tickets = await confirmResp.json();
      const out = document.getElementById('result');

      if(Array.isArray(tickets)){
        out.innerHTML = `<p>Paiement confirmé — ${tickets.length} billet(s) créé(s):</p>` +
          tickets.map(t=>`<div style="padding:6px 0">Réf: <strong>${t.reference}</strong> — Siège: <strong>${t.seat_number||'N/A'}</strong> — <a href="${t.qr_code}" target="_blank">QR</a></div>`).join('');
      } else {
        out.innerHTML = `<p>Paiement confirmé — billet créé. Réf: <strong>${tickets.reference}</strong></p>`;
      }
    });
  }
}

function showModal(unitPrice, onPay){
  const modal = document.getElementById('paymentModal');
  const bodyP = document.getElementById('pm-body');
  const qtyInput = document.getElementById('pm-quantity');
  const payBtn = document.getElementById('pm-pay');
  const cancelBtn = document.getElementById('pm-cancel');

  function updateAmountDisplay(qty){
    if(qty < 1) qty = 1;
    if(qty > 5) qty = 5;
    qtyInput.value = qty;
    const total = (Number(unitPrice)||0) * qty;
    bodyP.innerText = `Montant total: ${total.toFixed(2)} TND`;
  }

  qtyInput.value = 1;
  updateAmountDisplay(1);

  qtyInput.oninput = () => updateAmountDisplay(parseInt(qtyInput.value) || 1);

  modal.style.display = 'flex';

  cancelBtn.onclick = () => { modal.style.display='none'; payBtn.onclick=null; cancelBtn.onclick=null; };

  payBtn.onclick = async () => {
    const qty = parseInt(qtyInput.value) || 1;
    if(qty<1 || qty>5){ alert('Quantité invalide (1–5)'); return; }
    const noCard = document.getElementById('pm-no-card').value.trim();
    if(noCard && noCard.replace(/\D/g,'').length!==26){ alert('Le code de la carte doit contenir exactement 26 chiffres.'); return; }
    try{ await onPay(qty); } finally{ modal.style.display='none'; }
  };
}

load();
</script>
{% endblock %}
