{% extends 'base.html' %}
{% block content %}
<section style="margin-bottom: 2rem;">
  <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">Tous les √©v√©nements</h2>
  <p class="muted">Parcourez tous les √©v√©nements disponibles en Tunisie</p>
</section>

<section>
  <div id="events" class="events-grid">Chargement...</div>
</section>

<script>
async function fetchAllEvents(){
  try {
    const res = await fetch('/api/events/?ordering=date');
    if (!res.ok) {
      document.getElementById('events').innerHTML = '<p class="muted">Erreur lors du chargement des √©v√©nements.</p>';
      return;
    }
    
    const data = await res.json();
    const container = document.getElementById('events');
    
    if (!data || data.length === 0) {
      container.innerHTML = '<p class="muted">Aucun √©v√©nement disponible pour le moment.</p>';
      return;
    }
    
    container.innerHTML = '';
    
    data.forEach(ev => {
      const div = document.createElement('article');
      div.className = 'card event-card';
      
      const eventDate = new Date(ev.date);
      const formattedDate = eventDate.toLocaleDateString('fr-TN', { 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric' 
      });
      
      const locationName = ev.location ? ev.location.name : 'Lieu √† confirmer';
      const categoryName = ev.category ? ev.category.name : 'Non cat√©goris√©';
      const price = ev.price ? `${ev.price} TND` : 'Gratuit';
      const description = ev.description ? ev.description.substring(0, 100) + '...' : '';
      
      div.innerHTML = `
        <img src="${ev.image || '/static/images/default-event.svg'}" alt="${ev.title}">
        <div style="padding: 1rem;">
          <div style="display: inline-block; background: rgba(44, 82, 130, 0.1); color: #2c5282; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 500; margin-bottom: 0.75rem;">
            ${categoryName}
          </div>
          <h3>${ev.title}</h3>
          <p class="event-meta">üìÖ ${formattedDate}</p>
          <p class="event-meta">üìç ${locationName}</p>
          <p class="muted" style="margin-top: 0.75rem;">${description}</p>
          <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: space-between; align-items: center;">
            <div style="font-weight: 600; color: #2c5282; font-size: 1.125rem;">${price}</div>
            <button onclick="openEvent(${ev.id})" class="btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
              Voir d√©tails
            </button>
          </div>
        </div>`;
      container.appendChild(div);
    });
    
  } catch (error) {
    console.error('Error fetching events:', error);
    document.getElementById('events').innerHTML = '<p class="muted">Erreur lors du chargement des √©v√©nements.</p>';
  }
}

function openEvent(id){ 
  window.location.href = `/events/${id}/`; 
}

fetchAllEvents();
</script>
{% endblock %}